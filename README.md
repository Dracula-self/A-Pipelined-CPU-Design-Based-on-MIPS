# MIPS 32位流水线CPU设计

这是一个基于Verilog实现的MIPS 32位流水线CPU设计项目，支持基本的MIPS指令集，包含完整的五级流水线结构和冒险检测单元。

## 项目概述

本项目实现了一个完整的MIPS 32位流水线处理器，具有以下特点：

- **五级流水线架构**：指令提取(IF)、指令译码(ID)、执行(EX)、内存访问(MEM)、写回(WB)
- **冒险检测与解决**：数据冒险前递、控制冒险处理、结构冒险避免
- **完整的存储器系统**：支持指令存储器和数据存储器分离
- **硬件平台适配**：针对Thinpad实验板设计，支持SRAM和外设接口

## 项目结构

```
CPUProject/
├── thinpad_top.srcs/
│   ├── sources_1/new/           # 主要源代码文件
│   │   ├── mips_pipeline_cpu.v  # 顶层CPU模块
│   │   ├── thinpad_top.v        # 实验板顶层模块
│   │   ├── if_stage.v           # 指令提取阶段
│   │   ├── id_stage.v           # 指令译码阶段
│   │   ├── ex_stage.v           # 执行阶段
│   │   ├── mem_stage.v          # 内存访问阶段
│   │   ├── wb_stage.v           # 写回阶段
│   │   ├── hazard_unit.v        # 冒险检测单元
│   │   ├── control_unit.v       # 控制单元
│   │   ├── alu.v                # 算术逻辑单元
│   │   ├── register_file.v      # 寄存器堆
│   │   └── ...                  # 其他辅助模块
│   ├── sim_1/new/               # 仿真测试文件
│   │   └── tb.sv                # 测试平台
│   └── constrs_1/new/           # 约束文件
│       └── thinpad_top.xdc      # 引脚约束
├── test/                        # 测试程序
│   ├── mips-lab1.bin           # 测试程序1
│   ├── mips32-01.bin           # 测试程序2
│   └── mips32-02.bin           # 测试程序3
└── README.md                   # 项目说明文档
```

## CPU架构设计

### 流水线结构

本CPU采用经典的五级流水线结构：

1. **IF (Instruction Fetch) - 指令提取**
   - PC生成和更新
   - 指令存储器访问
   - 支持分支和跳转指令

2. **ID (Instruction Decode) - 指令译码**
   - 指令解码和控制信号生成
   - 寄存器文件读取
   - 立即数扩展
   - 分支条件判断

3. **EX (Execute) - 执行**
   - ALU运算
   - 数据前递处理
   - 目标寄存器选择

4. **MEM (Memory Access) - 内存访问**
   - 数据存储器读写
   - SW-LW前递处理

5. **WB (Write Back) - 写回**
   - 结果写回寄存器文件
   - 数据源选择

### 冒险检测与解决

#### 数据冒险
- **EX-EX前递**：EX阶段结果前递到下一条指令的EX阶段
- **MEM-EX前递**：MEM阶段结果前递到EX阶段
- **WB-EX前递**：WB阶段结果前递到EX阶段
- **分支前递**：解决分支指令的数据依赖

#### 控制冒险
- **分支预测**：默认不跳转预测
- **流水线冲刷**：分支判断错误时冲刷流水线
- **跳转处理**：J和JAL指令的目标地址计算

#### Load-Use冒险
- **流水线暂停**：LW指令后紧跟使用其结果的指令时暂停流水线
- **SW-LW前递**：特殊处理SW紧跟LW到相同地址的情况

## 支持的指令集

### R型指令
- `ADD`, `ADDU` - 加法运算
- `SUB`, `SUBU` - 减法运算
- `AND` - 逻辑与
- `OR` - 逻辑或
- `XOR` - 逻辑异或
- `NOR` - 逻辑或非
- `SLT`, `SLTU` - 比较指令
- `SLL`, `SRL`, `SRA` - 移位指令

### I型指令
- `ADDI`, `ADDIU` - 立即数加法
- `ANDI` - 立即数逻辑与
- `ORI` - 立即数逻辑或
- `SLTI`, `SLTIU` - 立即数比较
- `LUI` - 加载立即数到高位
- `LW` - 载入字
- `SW` - 存储字
- `BEQ` - 相等分支
- `BNE` - 不等分支

### J型指令
- `J` - 无条件跳转
- `JAL` - 跳转并链接

## 存储器系统

### 指令存储器
- **Base RAM**: 存储程序指令
- **地址范围**: 0x80000000 - 0x803FFFFF
- **访问方式**: 只读

### 数据存储器  
- **Ext RAM**: 存储程序数据
- **地址范围**: 0x80400000 - 0x807FFFFF
- **访问方式**: 读写

### 存储器接口
- 支持32位字访问
- 字节使能控制
- 同步写入，异步读取

## 开发环境

### 硬件要求
- Thinpad实验板
- Xilinx Artix-7 FPGA

### 软件工具
- Vivado 2019.2 

## 使用说明

### 1. 项目构建

1. 打开Vivado
2. 导入项目文件 `thinpad_top.xpr`
3. 运行综合(Synthesis)
4. 运行实现(Implementation)
5. 生成比特流文件

### 2. 仿真测试

1. 打开仿真模式
2. 设置测试平台为 `tb.sv`
3. 配置测试程序路径：
   ```verilog
   parameter BASE_RAM_INIT_FILE = "path/to/your/test.bin";
   ```
4. 运行仿真

### 3. 硬件测试

1. 将生成的比特流文件下载到FPGA
2. 通过7段数码管观察PC值
3. 通过LED观察执行状态
4. 使用串口进行调试输出

## 测试程序

项目包含多个测试程序：

- `mips-lab1.bin`: 基础指令测试
- `mips32-01.bin`: 综合功能测试
- `mips32-02.bin`: 高级功能测试

## 调试功能

### 仿真调试
- 详细的流水线状态显示
- 存储器访问跟踪
- 指令执行跟踪

### 硬件调试
- PC值7段数码管显示
- LED状态指示
- UART调试输出

## 已知问题与限制

1. **指令集限制**: 不支持浮点运算指令
2. **中断处理**: 未实现中断和异常处理
3. **缓存系统**: 未实现指令和数据缓存
4. **虚拟内存**: 未实现虚拟地址转换

## 扩展方向

1. **指令集扩展**: 添加更多MIPS指令支持
2. **性能优化**: 实现分支预测、乱序执行
3. **存储系统**: 添加Cache和MMU支持
4. **外设接口**: 扩展更多外设支持


---

如有问题或建议，请通过项目仓库提交Issue。
